<!DOCTYPE html>
<html>
<head>
    <title>MinIO Upload Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        .upload-area { border: 2px dashed #ccc; padding: 40px; text-align: center; margin: 20px 0; }
        .file-item { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .delete-btn { background: #dc3545; }
        .delete-btn:hover { background: #c82333; }
    </style>
</head>
<body>
    <h1>MinIO Upload Test - DeenAI</h1>
    
    <div class="upload-area">
        <input type="file" id="fileInput" multiple>
        <br><br>
        <button onclick="uploadFiles()">Upload Files</button>
    </div>
    
    <div id="status"></div>

    <div id="bucketList"></div>
    <div id="fileList"></div>
    <div id="bucketFileList"></div>

    <script>
        const API_BASE = 'http://localhost:3001/files';
        let uploadedFiles = [];

        async function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            const status = document.getElementById('status');
            
            if (files.length === 0) {
                status.innerHTML = '<p style="color: red;">Please select files first</p>';
                return;
            }

            status.innerHTML = '<p>Uploading...</p>';

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    uploadedFiles.push(result);
                    status.innerHTML = '<p style="color: green;">Upload successful!</p>';
                } catch (error) {
                    status.innerHTML = `<p style="color: red;">Upload failed: ${error.message}</p>`;
                }
            }
            
            displayFiles();
            document.getElementById('fileInput').value = '';
        }

        async function deleteFile(fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/${fileName}`, { method: 'DELETE' });
                uploadedFiles = uploadedFiles.filter(f => f.fileName !== fileName);
                displayFiles();
                alert('File deleted successfully!');
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        async function getFileUrl(fileName) {
            try {
                const response = await fetch(`${API_BASE}/${fileName}`);
                const result = await response.json();
                window.open(result.fileUrl, '_blank');
            } catch (error) {
                alert('Failed to get file URL: ' + error.message);
            }
        }

        async function getFileUrlFromBucket(bucketName, fileName) {
            try {
                const response = await fetch(`${API_BASE}/${bucketName}/${fileName}`);
                const result = await response.json();
                window.open(result.fileUrl, '_blank');
            } catch (error) {
                alert('Failed to get file URL: ' + error.message);
            }
        }

        async function deleteFileFromBucket(bucketName, fileName) {
            if (!confirm(`Are you sure you want to delete "${fileName}" from bucket "${bucketName}"?`)) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/${bucketName}/${fileName}`, { method: 'DELETE' });
                loadFilesFromBucket(bucketName);
                alert('File deleted successfully!');
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        async function loadExistingFiles() {
            try {
                const response = await fetch(`${API_BASE}`);
                const result = await response.json();
                uploadedFiles = result.files.map(fileName => ({ fileName }));
                displayFiles();
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }

        function displayFiles() {
            console.log('Displaying files:', uploadedFiles);
            const fileList = document.getElementById('fileList');
            
            if (!fileList) {
                console.error('fileList element not found!');
                return;
            }
            
            console.log('Setting innerHTML for fileList');
            fileList.innerHTML = '<h3>Uploaded Files:</h3>';
            
            if (!uploadedFiles || uploadedFiles.length === 0) {
                fileList.innerHTML += '<p>No files found</p>';
                return;
            }
            
            uploadedFiles.forEach(file => {
                console.log('Processing file:', file);
                const fileHtml = `
                    <div class="file-item">
                        <strong>${file.fileName}</strong><br>
                        <button onclick="getFileUrl('${file.fileName}')">View</button>
                        <button class="delete-btn" onclick="deleteFile('${file.fileName}')">Delete</button>
                    </div>
                `;
                console.log('Adding HTML:', fileHtml);
                fileList.innerHTML += fileHtml;
            });
            
            console.log('Final fileList innerHTML:', fileList.innerHTML);
            console.log('fileList element:', fileList);
            console.log('fileList style:', fileList.style.cssText);
            
            // Force visibility
            fileList.style.display = 'block';
            fileList.style.visibility = 'visible';
        }

        async function loadBuckets() {
            try {
                const response = await fetch(`${API_BASE}/admin/buckets`);
                const result = await response.json();
                console.log('Buckets response:', result);
                displayBuckets(result.buckets);
            } catch (error) {
                console.error('Failed to load buckets:', error);
                document.getElementById('bucketList').innerHTML = '<h3>Available Buckets:</h3><p style="color: red;">Failed to load buckets</p>';
            }
        }

        async function deleteBucket(bucketName) {
            if (!confirm(`Are you sure you want to delete bucket "${bucketName}"? This will delete ALL files in the bucket!`)) {
                return;
            }
            
            try {
                await fetch(`${API_BASE}/admin/bucket/${bucketName}`, { method: 'DELETE' });
                loadBuckets();
                alert('Bucket deleted successfully!');
            } catch (error) {
                alert('Delete bucket failed: ' + error.message);
            }
        }

        function displayBuckets(buckets) {
            const bucketList = document.getElementById('bucketList');
            bucketList.innerHTML = '<h3>Available Buckets:</h3>';
            
            if (!buckets || buckets.length === 0) {
                bucketList.innerHTML += '<p>No buckets found</p>';
                return;
            }
            
            buckets.forEach(bucketName => {
                bucketList.innerHTML += `
                    <div class="file-item">
                        <strong>üìÅ ${bucketName}</strong><br>
                        <button onclick="loadFilesFromBucket('${bucketName}')">View Files</button>
                        <button class="delete-btn" onclick="deleteBucket('${bucketName}')">Delete Bucket</button>
                    </div>
                `;
            });
        }

        async function loadFilesFromBucket(bucketName) {
            try {
                console.log('Loading files from bucket:', bucketName);
                const response = await fetch(`${API_BASE}/bucket/${bucketName}/files`);
                const result = await response.json();
                console.log('Files response:', result);
                const bucketFiles = result.files.map(fileName => ({ fileName }));
                displayBucketFiles(bucketFiles, bucketName);
            } catch (error) {
                console.error('Failed to load files from bucket:', error);
            }
        }

        function displayBucketFiles(files, bucketName) {
            const bucketFileList = document.getElementById('bucketFileList');
            bucketFileList.innerHTML = `<h3>Files in ${bucketName}:</h3>`;
            
            if (!files || files.length === 0) {
                bucketFileList.innerHTML += '<p>No files found in this bucket</p>';
                return;
            }
            
            files.forEach(file => {
                bucketFileList.innerHTML += `
                    <div class="file-item">
                        <strong>${file.fileName}</strong><br>
                        <button onclick="getFileUrlFromBucket('${bucketName}', '${file.fileName}')">View</button>
                        <button class="delete-btn" onclick="deleteFileFromBucket('${bucketName}', '${file.fileName}')">Delete</button>
                    </div>
                `;
            });
        }

        // Load existing files and buckets on page load
        window.onload = function() {
            loadExistingFiles();
            loadBuckets();
        };
    </script>
</body>
</html>